<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Console</title>
    <link rel="stylesheet" type="text/css" href="./src/wmks-all.css" />
    <link rel="stylesheet" href="./src/style.css">
</head>

<body>
    <script type="text/javascript" src="./src/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="./src/jquery-ui.min.js"></script>
    <script type="text/javascript" src="./src/wmks.min.js"></script>
    <div id="wmksContainer" style="position:absolute;width:100%;height:100%">
        <div class="cred">
            <div>
                <button id="sendCAD">
                    Ctrl + Alt + Del
                </button>
                <button id="btnCreds">Creds</button>
            </div>
            <div id="creds" style="display: none;">
                <div>
                    @Model.Login
                </div>
                <div>
                    @Model.Password
                </div>
            </div>
        </div>
    </div>
    <div id="statusMessage">
        <h2>Connection error</h2>
        <p>
            <div>You need to use chromium based browser</div>
            <div>Make sure at your browser support JavaScript</div>
            <div>
                To fix the issue, please open following URL 
                <a href="https://@Model.HostIp/" target="_blank" onclick="refreshPage">https://@Model.HostIp/</a> 
                and accept the certificate.
            </div>
            <h2>!Refresh page after certificate accept!</h2>
        </p>
    </div>
    <script>
        const vmContainer = document.getElementById('wmksContainer');
        const statusMessage = document.getElementById('statusMessage');
        const btnCAD = document.getElementById('sendCAD');
        const btcCreds = document.getElementById('btnCreds');
        const creds = document.getElementById('creds');

        var wmks = WMKS.createWMKS("wmksContainer", {})
            .register(WMKS.CONST.Events.CONNECTION_STATE_CHANGE, function (event, data) {
                if (data.state == WMKS.CONST.ConnectionState.CONNECTED) {
                    console.log("connection state change : connected");
                    vmContainer.style.display = 'block';
                    statusMessage.style.display = 'none';
                }
                else {
                    console.log(data.state);
                    vmContainer.style.display = 'none';
                    statusMessage.style.display = 'block';
                }
            });
        wmks.connect("@Model.Uri"); 

        function refreshPage() {
            console.log('Refreshing page...');
            setTimeout(() => {location.reload()}, 7000);
        }

        btnCAD.addEventListener('click', function() {
            wmks.sendCAD();
        });

        btnCreds.addEventListener('click', function() {
            creds.style.display = creds.style.display === 'none' ? 'block' : 'none';
            setTimeout(() => {creds.style.display = 'none'}, 30000);
        });

        document.querySelector('a[target]').addEventListener('click', refreshPage);
    </script>
</body>

</html>